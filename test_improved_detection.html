<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Improved Photo Stone Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007ACC;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a99;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .image-container {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        .image-display {
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        canvas {
            display: block;
            max-width: 100%;
        }
        .stone-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .red-stone { color: #d63384; font-weight: bold; }
        .yellow-stone { color: #fd7e14; font-weight: bold; }
        .blue-stone { color: #0d6efd; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ¥Œ Improved Photo Stone Detection Test</h1>
        
        <div class="test-section">
            <h3>ðŸ“· Upload Test Image</h3>
            <input type="file" id="imageInput" accept="image/*">
            <button id="testDetectionBtn" disabled>Test Stone Detection</button>
            <button id="clearResultsBtn">Clear Results</button>
        </div>

        <div class="image-container" id="imageContainer" style="display: none;">
            <div>
                <h4>Original Image</h4>
                <img id="originalImage" class="image-display" style="max-width: 400px;">
            </div>
            <div>
                <h4>Detection Canvas</h4>
                <canvas id="detectionCanvas" class="image-display" width="400" height="300"></canvas>
            </div>
        </div>

        <div class="test-section">
            <h3>ðŸŽ¯ Detection Results</h3>
            <div id="detectionResults" class="results">No detection performed yet...</div>
        </div>

        <div class="test-section">
            <h3>ðŸ“‹ Detected Stones</h3>
            <div id="stonesList" class="stone-list">No stones detected yet...</div>
        </div>

        <div class="test-section">
            <h3>ðŸ”§ Debug Information</h3>
            <div id="debugInfo" class="results">Debug info will appear here...</div>
        </div>
    </div>

    <script>
        // Improved Photo Stone Detection (matching the enhanced version)
        class ImprovedPhotoStoneDetection {
            constructor() {
                this.TEE_X = 28.35;
                this.viewArea = 8.0; // 8m x 8m view area
            }

            isRedStone(r, g, b) {
                // More relaxed red detection for canvas-resized images
                return (r > 110 && r > g + 15 && r > b + 15 && r < 200);
            }

            isYellowStone(r, g, b) {
                // Relaxed yellow detection for canvas-resized images
                return (r > 140 && g > 120 && b < 120 && Math.abs(r - g) < 60);
            }

            isBlueStone(r, g, b) {
                // Relaxed blue detection for canvas-resized images  
                return (b > 90 && b > r + 10 && b > g + 5 && r < 130 && g < 140);
            }

            convertToSheetCoordinates(pixelX, pixelY, imageWidth, imageHeight) {
                // Fixed coordinate conversion with Y-flip for correct orientation
                // Based on orientation analysis: red stones at bottom need to map to house (top)
                
                // Normalize to [-1, 1] range
                const normalizedX = (pixelX / imageWidth - 0.5) * 2;
                const normalizedY = (pixelY / imageHeight - 0.5) * 2;
                
                // Map to 8m x 8m area around the tee with Y-flip
                const sheetX = this.TEE_X + normalizedX * this.viewArea / 2;
                const sheetY = 0 - normalizedY * this.viewArea / 2; // Y-flip for correct orientation
                
                return { x: sheetX, y: sheetY };
            }

            analyzeImage(canvas) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                const redCandidates = [];
                const yellowCandidates = [];
                const blueCandidates = [];
                
                // Sample every 15th pixel for better accuracy
                const step = 15;
                
                for (let y = 0; y < canvas.height; y += step) {
                    for (let x = 0; x < canvas.width; x += step) {
                        const index = (y * canvas.width + x) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        
                        if (this.isRedStone(r, g, b)) {
                            redCandidates.push({ x, y, r, g, b });
                        }
                        
                        if (this.isYellowStone(r, g, b)) {
                            yellowCandidates.push({ x, y, r, g, b });
                        }
                        
                        if (this.isBlueStone(r, g, b)) {
                            blueCandidates.push({ x, y, r, g, b });
                        }
                    }
                }
                
                // Group nearby candidates into stones with adjusted parameters for canvas
                const redStones = this.groupIntoStones(redCandidates, 50, 5);
                const yellowStones = this.groupIntoStones(yellowCandidates, 50, 5);
                const blueStones = this.groupIntoStones(blueCandidates, 60, 5);
                
                // Take only top candidates to avoid false positives
                const finalRedStones = redStones.slice(0, 3);
                const finalYellowStones = yellowStones.slice(0, 2);
                const finalBlueStones = blueStones.slice(0, 2);
                
                // Convert to sheet coordinates
                const detectedStones = [];
                
                finalRedStones.forEach((stone, i) => {
                    const coords = this.convertToSheetCoordinates(
                        stone.x, stone.y, canvas.width, canvas.height
                    );
                    detectedStones.push({
                        id: `red_${i}`,
                        team: 'red',
                        x: coords.x,
                        y: coords.y,
                        pixel: { x: stone.x, y: stone.y },
                        confidence: stone.confidence
                    });
                });
                
                finalYellowStones.forEach((stone, i) => {
                    const coords = this.convertToSheetCoordinates(
                        stone.x, stone.y, canvas.width, canvas.height
                    );
                    detectedStones.push({
                        id: `yellow_${i}`,
                        team: 'yellow',
                        x: coords.x,
                        y: coords.y,
                        pixel: { x: stone.x, y: stone.y },
                        confidence: stone.confidence
                    });
                });
                
                finalBlueStones.forEach((stone, i) => {
                    const coords = this.convertToSheetCoordinates(
                        stone.x, stone.y, canvas.width, canvas.height
                    );
                    detectedStones.push({
                        id: `blue_${i}`,
                        team: 'blue',
                        x: coords.x,
                        y: coords.y,
                        pixel: { x: stone.x, y: stone.y },
                        confidence: stone.confidence
                    });
                });
                
                return {
                    stones: detectedStones,
                    debug: {
                        redCandidates: redCandidates.length,
                        yellowCandidates: yellowCandidates.length,
                        blueCandidates: blueCandidates.length,
                        redStones: finalRedStones.length,
                        yellowStones: finalYellowStones.length,
                        blueStones: finalBlueStones.length
                    }
                };
            }

            groupIntoStones(candidates, minDistance = 50, minPixels = 5) {
                if (candidates.length === 0) return [];
                
                const stones = [];
                const used = new Set();
                
                for (let i = 0; i < candidates.length; i++) {
                    if (used.has(i)) continue;
                    
                    const group = [candidates[i]];
                    used.add(i);
                    
                    // Find nearby candidates
                    for (let j = i + 1; j < candidates.length; j++) {
                        if (used.has(j)) continue;
                        
                        const dist = Math.sqrt(
                            Math.pow(candidates[i].x - candidates[j].x, 2) +
                            Math.pow(candidates[i].y - candidates[j].y, 2)
                        );
                        
                        if (dist < minDistance) {
                            group.push(candidates[j]);
                            used.add(j);
                        }
                    }
                    
                    // Only consider groups with enough pixels
                    if (group.length >= minPixels) {
                        // Calculate center of group
                        const centerX = group.reduce((sum, p) => sum + p.x, 0) / group.length;
                        const centerY = group.reduce((sum, p) => sum + p.y, 0) / group.length;
                        
                        stones.push({
                            x: centerX,
                            y: centerY,
                            confidence: group.length
                        });
                    }
                }
                
                return stones.sort((a, b) => b.confidence - a.confidence);
            }

            drawDetectionOverlay(canvas, results) {
                const ctx = canvas.getContext('2d');
                
                // Draw detected stones with different colors for each team
                results.stones.forEach(stone => {
                    let fillStyle, strokeStyle;
                    
                    if (stone.team === 'red') {
                        fillStyle = 'rgba(255, 0, 0, 0.7)';
                        strokeStyle = '#ff0000';
                    } else if (stone.team === 'yellow') {
                        fillStyle = 'rgba(255, 255, 0, 0.7)';
                        strokeStyle = '#ffff00';
                    } else if (stone.team === 'blue') {
                        fillStyle = 'rgba(0, 0, 255, 0.7)';
                        strokeStyle = '#0000ff';
                    }
                    
                    ctx.fillStyle = fillStyle;
                    ctx.strokeStyle = strokeStyle;
                    ctx.lineWidth = 3;
                    
                    const radius = 15;
                    
                    ctx.beginPath();
                    ctx.arc(stone.pixel.x, stone.pixel.y, radius, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Add label
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(
                        `${stone.team[0].toUpperCase()}${stone.id.split('_')[1]}`,
                        stone.pixel.x,
                        stone.pixel.y + 4
                    );
                });
            }
        }

        // UI Event Handlers
        const imageInput = document.getElementById('imageInput');
        const testBtn = document.getElementById('testDetectionBtn');
        const clearBtn = document.getElementById('clearResultsBtn');
        const originalImg = document.getElementById('originalImage');
        const detectionCanvas = document.getElementById('detectionCanvas');
        const imageContainer = document.getElementById('imageContainer');
        const detectionResults = document.getElementById('detectionResults');
        const stonesList = document.getElementById('stonesList');
        const debugInfo = document.getElementById('debugInfo');

        const detector = new ImprovedPhotoStoneDetection();

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImg.src = e.target.result;
                    originalImg.onload = function() {
                        imageContainer.style.display = 'flex';
                        testBtn.disabled = false;
                        
                        debugInfo.textContent = `Image loaded: ${originalImg.naturalWidth}x${originalImg.naturalHeight} pixels\nCanvas size: ${detectionCanvas.width}x${detectionCanvas.height} pixels`;
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        testBtn.addEventListener('click', function() {
            if (!originalImg.src) return;
            
            detectionResults.textContent = 'Analyzing image...';
            
            // Draw image to canvas
            const ctx = detectionCanvas.getContext('2d');
            ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
            ctx.drawImage(originalImg, 0, 0, detectionCanvas.width, detectionCanvas.height);
            
            // Analyze
            const results = detector.analyzeImage(detectionCanvas);
            
            // Draw overlay
            detector.drawDetectionOverlay(detectionCanvas, results);
            
            // Display results
            detectionResults.textContent = 
                `ðŸŽ¯ DETECTION COMPLETE\n` +
                `Total stones found: ${results.stones.length}\n` +
                `Red stones: ${results.stones.filter(s => s.team === 'red').length}\n` +
                `Yellow stones: ${results.stones.filter(s => s.team === 'yellow').length}\n` +
                `Blue stones: ${results.stones.filter(s => s.team === 'blue').length}\n\n` +
                `ðŸ“Š ANALYSIS DETAILS\n` +
                `Red candidates: ${results.debug.redCandidates}\n` +
                `Yellow candidates: ${results.debug.yellowCandidates}\n` +
                `Blue candidates: ${results.debug.blueCandidates}\n` +
                `Final red stones: ${results.debug.redStones}\n` +
                `Final yellow stones: ${results.debug.yellowStones}\n` +
                `Final blue stones: ${results.debug.blueStones}`;
            
            // Display stone list
            let stoneListHtml = '';
            results.stones.forEach(stone => {
                let className;
                if (stone.team === 'red') className = 'red-stone';
                else if (stone.team === 'yellow') className = 'yellow-stone';
                else if (stone.team === 'blue') className = 'blue-stone';
                
                stoneListHtml += 
                    `<div class="${className}">${stone.team.toUpperCase()} ${stone.id.split('_')[1]}: ` +
                    `Sheet(${stone.x.toFixed(2)}m, ${stone.y.toFixed(2)}m) ` +
                    `Pixel(${stone.pixel.x.toFixed(0)}, ${stone.pixel.y.toFixed(0)}) ` +
                    `Confidence: ${stone.confidence}</div>`;
            });
            stonesList.innerHTML = stoneListHtml || 'No stones detected';
        });

        clearBtn.addEventListener('click', function() {
            imageInput.value = '';
            originalImg.src = '';
            imageContainer.style.display = 'none';
            testBtn.disabled = true;
            detectionResults.textContent = 'No detection performed yet...';
            stonesList.textContent = 'No stones detected yet...';
            debugInfo.textContent = 'Debug info will appear here...';
            
            const ctx = detectionCanvas.getContext('2d');
            ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
        });
    </script>
</body>
</html>