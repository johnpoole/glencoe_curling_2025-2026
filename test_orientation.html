<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Orientation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007ACC;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a99;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .image-container {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        .image-display {
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        canvas {
            display: block;
            max-width: 100%;
        }
        .orientation-overlay {
            position: relative;
            display: inline-block;
        }
        .direction-arrow {
            position: absolute;
            color: red;
            font-size: 24px;
            font-weight: bold;
            background: rgba(255,255,255,0.8);
            padding: 5px;
            border-radius: 3px;
        }
        .throwing-direction {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        .section-label {
            position: absolute;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            right: 10px;
        }
        .top-label { top: 10px; }
        .middle-label { top: 50%; transform: translateY(-50%); }
        .bottom-label { bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß≠ Photo Orientation Test</h1>
        <p><strong>Expected:</strong> Stones thrown from BOTTOM to TOP of image</p>
        <p><strong>Should find:</strong> 2 red stones (in house area), 1 blue guard stone</p>
        
        <div class="test-section">
            <h3>üì∑ Upload Test Image</h3>
            <input type="file" id="imageInput" accept="image/*">
            <button id="analyzeOrientationBtn" disabled>Analyze Photo Orientation</button>
            <button id="clearResultsBtn">Clear Results</button>
        </div>

        <div class="image-container" id="imageContainer" style="display: none;">
            <div class="orientation-overlay">
                <img id="originalImage" class="image-display" style="max-width: 400px;">
                <div class="direction-arrow throwing-direction">‚Üë Throwing Direction</div>
                <div class="section-label top-label">TOP (House Area)</div>
                <div class="section-label middle-label">MIDDLE (Guard Zone)</div>
                <div class="section-label bottom-label">BOTTOM (Throwing Area)</div>
            </div>
            <div>
                <h4>Orientation Analysis Canvas</h4>
                <canvas id="analysisCanvas" class="image-display" width="400" height="300"></canvas>
            </div>
        </div>

        <div class="test-section">
            <h3>üîç Orientation Analysis Results</h3>
            <div id="orientationResults" class="results">No analysis performed yet...</div>
        </div>

        <div class="test-section">
            <h3>üìä Stone Distribution by Section</h3>
            <div id="sectionAnalysis" class="results">Upload image and analyze to see distribution...</div>
        </div>

        <div class="test-section">
            <h3>‚úÖ Orientation Validation</h3>
            <div id="validationResults" class="results">Analysis results will show if orientation assumptions are correct...</div>
        </div>
    </div>

    <script>
        class PhotoOrientationTester {
            constructor() {
                this.uploadedImage = null;
            }

            analyzeOrientation(canvas) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Divide image into three vertical sections
                const sectionHeight = Math.floor(canvas.height / 3);
                
                const sections = {
                    'TOP (House Area)': { start: 0, end: sectionHeight },
                    'MIDDLE (Guard Zone)': { start: sectionHeight, end: 2 * sectionHeight },
                    'BOTTOM (Throwing Area)': { start: 2 * sectionHeight, end: canvas.height }
                };
                
                const results = {};
                
                Object.entries(sections).forEach(([name, bounds]) => {
                    let redPixels = 0;
                    let bluePixels = 0;
                    let yellowPixels = 0;
                    let totalSampled = 0;
                    
                    // Sample every 10 pixels within this section
                    const step = 10;
                    
                    for (let y = bounds.start; y < bounds.end; y += step) {
                        for (let x = 0; x < canvas.width; x += step) {
                            const index = (y * canvas.width + x) * 4;
                            if (index + 2 < data.length) {
                                const r = data[index];
                                const g = data[index + 1];
                                const b = data[index + 2];
                                
                                totalSampled++;
                                
                                // Loose detection for orientation testing
                                if (this.isLooseRed(r, g, b)) redPixels++;
                                if (this.isLooseBlue(r, g, b)) bluePixels++;
                                if (this.isLooseYellow(r, g, b)) yellowPixels++;
                            }
                        }
                    }
                    
                    results[name] = {
                        red: redPixels,
                        blue: bluePixels,
                        yellow: yellowPixels,
                        total: totalSampled,
                        redPercent: totalSampled > 0 ? (redPixels / totalSampled * 100) : 0,
                        bluePercent: totalSampled > 0 ? (bluePixels / totalSampled * 100) : 0,
                        yellowPercent: totalSampled > 0 ? (yellowPixels / totalSampled * 100) : 0
                    };
                });
                
                return results;
            }
            
            isLooseRed(r, g, b) {
                // Very loose red detection for orientation purposes
                return (r > g + 10 && r > b + 10 && r > 80);
            }
            
            isLooseBlue(r, g, b) {
                // Very loose blue detection for orientation purposes
                return (b > r + 10 && b > g + 5 && b > 70);
            }
            
            isLooseYellow(r, g, b) {
                // Very loose yellow detection for orientation purposes
                return (r > 100 && g > 100 && b < 80 && Math.abs(r - g) < 50);
            }
            
            validateOrientation(results) {
                // Expected based on user description:
                // - TOP section should have red stones (house area)
                // - MIDDLE section should have guard stones
                // - BOTTOM section should have fewer stones (throwing area)
                
                const validation = {
                    correct: true,
                    issues: [],
                    recommendations: []
                };
                
                const topSection = results['TOP (House Area)'];
                const middleSection = results['MIDDLE (Guard Zone)'];
                const bottomSection = results['BOTTOM (Throwing Area)'];
                
                // Check red stone distribution (should be highest in TOP for house)
                const maxRedSection = Object.keys(results).reduce((a, b) => 
                    results[a].red > results[b].red ? a : b
                );
                
                if (!maxRedSection.includes('TOP')) {
                    validation.correct = false;
                    validation.issues.push(`Red stones concentrated in ${maxRedSection}, expected in TOP (house area)`);
                    validation.recommendations.push('Photo orientation may be incorrect or coordinate system needs adjustment');
                }
                
                // Check blue stone distribution
                const maxBlueSection = Object.keys(results).reduce((a, b) => 
                    results[a].blue > results[b].blue ? a : b
                );
                
                // Check total stone distribution (should decrease from top to bottom)
                const topTotal = topSection.red + topSection.blue + topSection.yellow;
                const bottomTotal = bottomSection.red + bottomSection.blue + bottomSection.yellow;
                
                if (bottomTotal > topTotal) {
                    validation.issues.push('More stones in throwing area than target area - unusual for end-of-game photo');
                }
                
                // Provide coordinate system guidance
                validation.coordinateSystem = {
                    imageOrigin: 'TOP-LEFT (0,0)',
                    throwingDirection: 'BOTTOM ‚Üí TOP (decreasing Y)',
                    houseLocation: 'Should be at LOW Y coordinates (top of image)',
                    guardLocation: 'Should be at MIDDLE Y coordinates'
                };
                
                return validation;
            }
            
            drawAnalysisOverlay(canvas, results) {
                const ctx = canvas.getContext('2d');
                
                // Draw section boundaries
                const sectionHeight = canvas.height / 3;
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                
                // Top-middle boundary
                ctx.beginPath();
                ctx.moveTo(0, sectionHeight);
                ctx.lineTo(canvas.width, sectionHeight);
                ctx.stroke();
                
                // Middle-bottom boundary
                ctx.beginPath();
                ctx.moveTo(0, 2 * sectionHeight);
                ctx.lineTo(canvas.width, 2 * sectionHeight);
                ctx.stroke();
                
                ctx.setLineDash([]); // Reset line dash
                
                // Add section labels with results
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                
                const sections = [
                    { name: 'TOP', y: sectionHeight / 2, data: results['TOP (House Area)'] },
                    { name: 'MIDDLE', y: sectionHeight + sectionHeight / 2, data: results['MIDDLE (Guard Zone)'] },
                    { name: 'BOTTOM', y: 2 * sectionHeight + sectionHeight / 2, data: results['BOTTOM (Throwing Area)'] }
                ];
                
                sections.forEach(section => {
                    const text = `${section.name}: R:${section.data.red} B:${section.data.blue}`;
                    const textWidth = ctx.measureText(text).width;
                    
                    // Background for text
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.fillRect(canvas.width / 2 - textWidth / 2 - 5, section.y - 10, textWidth + 10, 20);
                    
                    // Text
                    ctx.fillStyle = 'black';
                    ctx.fillText(text, canvas.width / 2, section.y + 5);
                });
            }
        }

        // UI Event Handlers
        const imageInput = document.getElementById('imageInput');
        const analyzeBtn = document.getElementById('analyzeOrientationBtn');
        const clearBtn = document.getElementById('clearResultsBtn');
        const originalImg = document.getElementById('originalImage');
        const analysisCanvas = document.getElementById('analysisCanvas');
        const imageContainer = document.getElementById('imageContainer');
        const orientationResults = document.getElementById('orientationResults');
        const sectionAnalysis = document.getElementById('sectionAnalysis');
        const validationResults = document.getElementById('validationResults');

        const tester = new PhotoOrientationTester();

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImg.src = e.target.result;
                    originalImg.onload = function() {
                        tester.uploadedImage = originalImg;
                        imageContainer.style.display = 'flex';
                        analyzeBtn.disabled = false;
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        analyzeBtn.addEventListener('click', function() {
            if (!tester.uploadedImage) return;
            
            orientationResults.textContent = 'Analyzing photo orientation...';
            
            // Draw image to canvas
            const ctx = analysisCanvas.getContext('2d');
            ctx.clearRect(0, 0, analysisCanvas.width, analysisCanvas.height);
            ctx.drawImage(tester.uploadedImage, 0, 0, analysisCanvas.width, analysisCanvas.height);
            
            // Analyze orientation
            const results = tester.analyzeOrientation(analysisCanvas);
            const validation = tester.validateOrientation(results);
            
            // Draw analysis overlay
            tester.drawAnalysisOverlay(analysisCanvas, results);
            
            // Display results
            orientationResults.textContent = 
                `üß≠ PHOTO ORIENTATION ANALYSIS\n\n` +
                `Image Coordinate System:\n` +
                `  Origin: ${validation.coordinateSystem.imageOrigin}\n` +
                `  Throwing Direction: ${validation.coordinateSystem.throwingDirection}\n` +
                `  House Location: ${validation.coordinateSystem.houseLocation}\n` +
                `  Guard Location: ${validation.coordinateSystem.guardLocation}`;
            
            // Section analysis
            let sectionText = 'üìä STONE DISTRIBUTION BY SECTION\n\n';
            Object.entries(results).forEach(([section, data]) => {
                sectionText += `${section}:\n`;
                sectionText += `  Red pixels: ${data.red} (${data.redPercent.toFixed(1)}%)\n`;
                sectionText += `  Blue pixels: ${data.blue} (${data.bluePercent.toFixed(1)}%)\n`;
                sectionText += `  Yellow pixels: ${data.yellow} (${data.yellowPercent.toFixed(1)}%)\n`;
                sectionText += `  Total sampled: ${data.total}\n\n`;
            });
            sectionAnalysis.textContent = sectionText;
            
            // Validation results
            let validationText = '‚úÖ ORIENTATION VALIDATION\n\n';
            validationText += `Status: ${validation.correct ? 'CORRECT' : 'POTENTIAL ISSUES'}\n\n`;
            
            if (validation.issues.length > 0) {
                validationText += 'Issues Found:\n';
                validation.issues.forEach(issue => {
                    validationText += `  ‚ö† ${issue}\n`;
                });
                validationText += '\n';
            }
            
            if (validation.recommendations.length > 0) {
                validationText += 'Recommendations:\n';
                validation.recommendations.forEach(rec => {
                    validationText += `  üí° ${rec}\n`;
                });
            }
            
            validationResults.textContent = validationText;
        });

        clearBtn.addEventListener('click', function() {
            imageInput.value = '';
            originalImg.src = '';
            imageContainer.style.display = 'none';
            analyzeBtn.disabled = true;
            orientationResults.textContent = 'No analysis performed yet...';
            sectionAnalysis.textContent = 'Upload image and analyze to see distribution...';
            validationResults.textContent = 'Analysis results will show if orientation assumptions are correct...';
            
            const ctx = analysisCanvas.getContext('2d');
            ctx.clearRect(0, 0, analysisCanvas.width, analysisCanvas.height);
        });
    </script>
</body>
</html>