<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Curling Draw Simulator — D3</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div class="wrap">
  <!-- Sheet panel first (full width) -->
  <div class="panel">
    <svg id="rink"></svg>
  </div>
  
  <!-- Controls panel below -->
  <div class="panel controls-panel">
    <!-- First column - Shot parameters -->
    <fieldset>
      <legend>Shot</legend>
      <div class="row">
        <span class="input-label">Throw Weight (m/s)</span>
        <div class="slider-container">
          <input id="V0" type="range" step="0.01" min="1.76" max="3" value="1.93">
          <span class="slider-value" id="V0-value">1.93</span>
        </div>
      </div>
      <div class="row">
        <label>Spin |ω0| (rad/s)
          <input id="omega0" type="number" step="0.01" min="0" max="5" value="1.45">
        </label>
        <label>Turn
          <select id="turn"><option value="out">out (CW)</option><option value="in">in (CCW)</option></select>
        </label>
      </div>
      <label>Initial Sweep factor (×)
        <input id="sweep" type="number" step="0.01" min="0.5" max="1.5" value="1.0">
      </label>
      <div id="sweepControlsContainer" style="display: none; margin-top: 10px;">
        <div class="row" style="align-items: center;">
          <span>Active Sweeping</span>
          <div class="slider-container">
            <input id="activeSweep" type="range" step="0.01" min="0.5" max="1.0" value="0.75">
            <span class="slider-value" id="activeSweep-value">0.75</span>
          </div>
        </div>
        <div class="small" style="margin-top: 5px;">Press and hold the spacebar to sweep during shot</div>
      </div>
      <div style="text-align: right; margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
        <button id="helpBtn" class="secondary" title="Help & Keyboard Shortcuts (? key)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          Help
        </button>
        <button id="settingsBtn" class="secondary" title="Advanced Settings">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
          Settings
        </button>
      </div>
      <div class="small">Click on the sheet to place the skip’s broom. Rock won’t move until you press <b>Throw</b>.</div>
    </fieldset>

    <!-- Third column - Buttons and metrics -->
    <div>
      <div class="buttons">
        <button id="throwBtn" title="Throw the rock (Enter)">Throw</button>
        <button id="resetBtn" class="secondary" title="Reset the shot (R)">Reset</button>
        <button id="csvBtn" class="secondary" title="Export position evaluation data as JSON">Export</button>
        <button id="stopBtn" class="warn" title="Stop the current shot">Stop</button>
      </div>
      
      <hr style="border:0;border-top:1px solid #2a3a52; margin:10px 0;">
      
      <!-- Game controls and scoring -->
      <fieldset style="border: 2px solid #79d27f;">
        <legend style="font-weight: bold; color: #79d27f;">Game Play</legend>
        
        <!-- Current game state -->
        <div class="game-state-info">
          <div class="state-row">
            <span>Current End: <b id="currentEndNumber">1</b></span>
            <span>Stones Thrown: <b id="stonesThrown">0</b>/16</span>
          </div>
          <div class="state-row">
            <span>Team to Throw: 
              <b id="teamToThrow" style="color: #e74c3c;">Red</b>
            </span>
            <span>Stone: <b id="stoneNumber">1</b></span>
          </div>
        </div>
        
        <!-- Team indicator and toggle -->
        <div class="team-indicator" style="margin: 10px 0;">
          <div class="team-name red">Red Team</div>
          <div class="score-display">
            <div class="score-box red" id="redScore">0</div>
            <div class="score-box yellow" id="yellowScore">0</div>
          </div>
          <div class="team-name yellow">Yellow Team</div>
        </div>
        
        <!-- Game control buttons -->
        <div class="buttons">
          <button id="nextThrowBtn" class="secondary" title="Set up for next throw (N)">Next Throw</button>
          <button id="scoreEndBtn" style="background-color: #79d27f; color: #03260d;" title="Score the current end (S)">Score End</button>
          <button id="viewScoreboardBtn" class="secondary" title="View game scoreboard (V)">View Scoreboard</button>
          <button id="resetEndBtn" class="warn" title="Reset the current end">Reset End</button>
        </div>
        
        <div id="endScoringDisplay" style="display: none; margin-top: 10px; text-align: center;">
          <div style="font-weight: bold; margin-bottom: 5px;">End Score</div>
          <div class="scoring-result">
            <span class="team-label red">Red:</span>
            <div class="score-buttons red">
              <button class="score-btn" data-team="red" data-score="0">0</button>
              <button class="score-btn" data-team="red" data-score="1">1</button>
              <button class="score-btn" data-team="red" data-score="2">2</button>
              <button class="score-btn" data-team="red" data-score="3">3</button>
              <button class="score-btn" data-team="red" data-score="4+">4+</button>
            </div>
          </div>
          <div class="scoring-result">
            <span class="team-label yellow">Yellow:</span>
            <div class="score-buttons yellow">
              <button class="score-btn" data-team="yellow" data-score="0">0</button>
              <button class="score-btn" data-team="yellow" data-score="1">1</button>
              <button class="score-btn" data-team="yellow" data-score="2">2</button>
              <button class="score-btn" data-team="yellow" data-score="3">3</button>
              <button class="score-btn" data-team="yellow" data-score="4+">4+</button>
            </div>
          </div>
          <div class="score-action-buttons" style="margin-top: 10px;">
            <button id="confirmScoreBtn" style="background-color: #79d27f;">Confirm Score</button>
            <button id="autoscoreBtn" class="secondary">Auto Score</button>
            <button id="cancelScoreBtn" class="warn">Cancel</button>
          </div>
        </div>
      </fieldset>

      <!-- Stone control buttons -->
      <fieldset>
        <legend>Stones</legend>
        <div class="buttons">
          <button id="removeStoneBtn" class="secondary">Remove Selected</button>
          <button id="clearStonesBtn" class="warn">Clear All</button>
        </div>
        <div class="small" style="margin-top:8px">Stones are added automatically when you click Throw. Click a stone to select it for throwing or removing.</div>
      </fieldset>
      
      <!-- Shot Exploration Button -->
      <div style="margin-top: 20px; text-align: right;">
        <button id="shotExplorationBtn" class="secondary" style="background-color: #4aa3ff; color: #03264d;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 18a5 5 0 0 1-10 0"></path>
            <line x1="12" y1="9" x2="12" y2="2"></line>
            <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line>
            <line x1="1" y1="18" x2="3" y2="18"></line>
            <line x1="21" y1="18" x2="23" y2="18"></line>
            <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line>
          </svg>
          Shot Exploration
        </button>
      </div>
      
      <hr style="border:0;border-top:1px solid #2a3a52; margin:10px 0;">
      <div class="metrics-container">
        <div class="metric"><span>Final x (m)</span><span class="v" id="mx"></span></div>
        <div class="metric"><span>Final curl y (m)</span><span class="v" id="my"></span></div>
        <div class="metric"><span>Total time (s)</span><span class="v" id="mt"></span></div>
        <div class="metric"><span>Hog→Hog time (s)</span><span class="v" id="mhh"></span></div>
      </div>
      
      <hr style="border:0;border-top:1px solid #2a3a52; margin:10px 0;">
      <div class="position-evaluation" id="positionEvaluation">
        <!-- Position evaluation results will be displayed here -->
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Advanced Settings</h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <fieldset>
        <legend>Animation Speed</legend>
        <div class="preset-buttons">
          <button id="presetVeryFast" class="preset-btn speed-btn">VERY FAST</button>
          <button id="presetSlowMotion" class="preset-btn speed-btn">SLOW MOTION</button>
        </div>
      </fieldset>
      
      <fieldset>
        <legend>Ice & Stone</legend>
        <div class="row">
          <label>ice speed
            <input id="mu0" type="number" step="0.0005" min="0.001" max="0.03" value="0.0075">
          </label>
          <label>stone sharpness
            <input id="alpha" type="number" step="0.0005" min="0.0" max="0.1" value="0.027">
          </label>
        </div>
      </fieldset>
      
      <fieldset>
        <legend>Advanced</legend>
        <div class="row">
          <label>Animation Speed
            <input id="animationSpeed" type="number" step="1" min="1" max="64" value="24">
          </label>
          <label>segments
            <input id="segments" type="number" step="1" min="60" max="720" value="180">
          </label>
        </div>
        <div class="row">
          <label>dt (s)
            <input id="dt" type="number" step="0.001" min="0.001" max="0.05" value="0.01">
          </label>
        <div class="row">
          <label>t_max (s)
            <input id="tmax" type="number" step="1" min="5" max="120" value="60">
          </label>
          <label>r_band (m)
            <input id="rband" type="number" step="0.001" min="0.04" max="0.09" value="0.065">
          </label>
        </div>
        <label>R (rock radius, m)
          <input id="R" type="number" step="0.001" min="0.12" max="0.17" value="0.145">
        </label>
      </fieldset>
    </div>
    <div class="modal-footer">
      <button id="closeSettingsBtn" class="secondary">Close</button>
    </div>
  </div>
</div>

<!-- Shot Exploration Modal -->
<div id="shotExplorationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" style="border-bottom-color: #4aa3ff;">
      <h3 style="color: #4aa3ff;">Shot Exploration</h3>
      <span class="close" id="closeShotExploration">&times;</span>
    </div>
    <div class="modal-body">
      <div class="buttons" style="margin-bottom: 15px;">
        <button id="showPathsBtn" class="secondary">Show Multiple Paths</button>
        <button id="hidePathsBtn" class="secondary">Hide Paths</button>
      </div>
      
      <fieldset>
        <legend>Path Settings</legend>
        <div class="controls">
          <div class="control-group">
            <label for="broomSpacing">Broom Spacing (m):</label>
            <input type="number" id="broomSpacing" value="0.1524" step="0.0254" min="0.0254" max="0.5">
            <div class="small">(0.0254m = 1 inch)</div>
          </div>
          <div class="control-group">
            <label for="velocityStart">Velocity Start (m/s):</label>
            <input type="number" id="velocityStart" value="1.8" step="0.1" min="1.0" max="3.0">
          </div>
          <div class="control-group">
            <label for="velocityEnd">Velocity End (m/s):</label>
            <input type="number" id="velocityEnd" value="2.8" step="0.1" min="1.0" max="3.0">
          </div>
          <div class="control-group">
            <label for="velocityStep">Velocity Step (m/s):</label>
            <input type="number" id="velocityStep" value="0.1" step="0.05" min="0.05" max="0.5">
          </div>
        </div>
      </fieldset>
      
      <fieldset>
        <legend>Display Options</legend>
        <div class="controls">
          <div class="control-group" style="margin-top: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="showCollisions" checked>
              <label for="showCollisions" style="display: inline; margin: 0;">Show Collision Paths</label>
            </div>
          </div>
          <div class="control-group">
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="showNonContactPaths" checked>
              <label for="showNonContactPaths" style="display: inline; margin: 0;">Show Non-Contact Paths</label>
            </div>
            <div class="small">Clear to hide trajectories that never touch another stone</div>
          </div>
          <div class="control-group">
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="filterPaths" checked>
              <label for="filterPaths" style="display: inline; margin: 0;">Filter Invalid Paths</label>
            </div>
            <div class="small">Only show paths that stop on the sheet or cause collisions</div>
          </div>
        </div>
      </fieldset>
      
      <div class="small" style="margin-top:15px">
        Shows trajectories for different broom positions and velocities. Hover over paths to see details.
      </div>
    </div>
    <div class="modal-footer" style="border-top-color: #4aa3ff;">
      <button id="closeShotExplorationBtn" class="secondary">Close</button>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" style="border-bottom-color: #4a7bff;">
      <h3 style="color: #4a7bff;">Help & Keyboard Shortcuts</h3>
      <span class="close" id="closeHelp">&times;</span>
    </div>
    <div class="modal-body">
      <h4>Keyboard Shortcuts</h4>
      <table class="help-table">
        <tr>
          <td><kbd>Enter</kbd></td>
          <td>Throw rock</td>
        </tr>
        <tr>
          <td><kbd>R</kbd></td>
          <td>Reset shot</td>
        </tr>
        <tr>
          <td><kbd>N</kbd></td>
          <td>Next throw</td>
        </tr>
        <tr>
          <td><kbd>S</kbd></td>
          <td>Score end</td>
        </tr>
        <tr>
          <td><kbd>V</kbd></td>
          <td>View scoreboard</td>
        </tr>
        <tr>
          <td><kbd>H</kbd> or <kbd>?</kbd></td>
          <td>Open this help window</td>
        </tr>
        <tr>
          <td><kbd>Space</kbd></td>
          <td>Hold to sweep during shot</td>
        </tr>
        <tr>
          <td><kbd>Esc</kbd></td>
          <td>Close any open modal</td>
        </tr>
      </table>
      
      <h4>How to Play</h4>
      <ol>
        <li>Click on the sheet to place the skip's broom (target)</li>
        <li>Adjust throw weight and turn direction</li>
        <li>Click "Throw" or press Enter to throw the rock</li>
        <li>Hold the spacebar to sweep during the shot</li>
        <li>After each end, click "Score End" to determine which team scores</li>
      </ol>
      
      <h4>Game Rules</h4>
      <ul>
        <li>Each team (Red and Yellow) throws 8 stones per end</li>
        <li>Teams alternate throws</li>
        <li>The team with stones closest to the center of the house scores points</li>
        <li>Only one team scores per end</li>
        <li>A team scores one point for each of their stones that is closer to the center than any of the opponent's stones</li>
      </ul>
    </div>
    <div class="modal-footer" style="border-top-color: #4a7bff;">
      <button id="closeHelpBtn" class="secondary">Close</button>
    </div>
  </div>
</div>

<!-- Scoreboard Modal -->
<div id="scoreboardModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" style="border-bottom-color: #79d27f;">
      <h3 style="color: #79d27f;">Game Scoreboard</h3>
      <span class="close" id="closeScoreboard">&times;</span>
    </div>
    <div class="modal-body">
      <div class="scoreboard-container">
        <table class="scoreboard-table">
          <thead>
            <tr>
              <th>Team</th>
              <th>1</th>
              <th>2</th>
              <th>3</th>
              <th>4</th>
              <th>5</th>
              <th>6</th>
              <th>7</th>
              <th>8</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr class="team-red">
              <td>Red</td>
              <td id="red-end-1">-</td>
              <td id="red-end-2">-</td>
              <td id="red-end-3">-</td>
              <td id="red-end-4">-</td>
              <td id="red-end-5">-</td>
              <td id="red-end-6">-</td>
              <td id="red-end-7">-</td>
              <td id="red-end-8">-</td>
              <td id="red-total">0</td>
            </tr>
            <tr class="team-yellow">
              <td>Yellow</td>
              <td id="yellow-end-1">-</td>
              <td id="yellow-end-2">-</td>
              <td id="yellow-end-3">-</td>
              <td id="yellow-end-4">-</td>
              <td id="yellow-end-5">-</td>
              <td id="yellow-end-6">-</td>
              <td id="yellow-end-7">-</td>
              <td id="yellow-end-8">-</td>
              <td id="yellow-total">0</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer" style="border-top-color: #79d27f;">
      <button id="closeScoreboardBtn" class="secondary">Close</button>
    </div>
  </div>
</div>

<script type="module" src="js/app.js"></script>
<script>
  // Modal functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Settings Modal
    const settingsModal = document.getElementById('settingsModal');
    const settingsBtn = document.getElementById('settingsBtn');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const closeSettingsBtnX = document.querySelector('#settingsModal .close');
    
    // Help Modal
    const helpModal = document.getElementById('helpModal');
    const helpBtn = document.getElementById('helpBtn');
    const closeHelpBtn = document.getElementById('closeHelpBtn');
    const closeHelpBtnX = document.querySelector('#helpModal .close');
    
    // Shot Exploration Modal
    const shotExplorationModal = document.getElementById('shotExplorationModal');
    const shotExplorationBtn = document.getElementById('shotExplorationBtn');
    const closeShotExplorationBtn = document.getElementById('closeShotExplorationBtn');
    const closeShotExplorationBtnX = document.querySelector('#shotExplorationModal .close');
    
    // Settings Modal Functions
    settingsBtn.addEventListener('click', function() {
      settingsModal.style.display = 'block';
    });
    
    closeSettingsBtnX.addEventListener('click', function() {
      settingsModal.style.display = 'none';
    });
    
    closeSettingsBtn.addEventListener('click', function() {
      settingsModal.style.display = 'none';
    });
    
    // Help Modal Functions
    helpBtn.addEventListener('click', function() {
      helpModal.style.display = 'block';
    });
    
    closeHelpBtnX.addEventListener('click', function() {
      helpModal.style.display = 'none';
    });
    
    closeHelpBtn.addEventListener('click', function() {
      helpModal.style.display = 'none';
    });
    
    // Shot Exploration Modal Functions
    shotExplorationBtn.addEventListener('click', function() {
      shotExplorationModal.style.display = 'block';
    });
    
    closeShotExplorationBtnX.addEventListener('click', function() {
      shotExplorationModal.style.display = 'none';
    });
    
    closeShotExplorationBtn.addEventListener('click', function() {
      shotExplorationModal.style.display = 'none';
    });
    
    // Scoreboard Modal Functions
    const scoreboardModal = document.getElementById('scoreboardModal');
    const viewScoreboardBtn = document.getElementById('viewScoreboardBtn');
    const closeScoreboardBtn = document.getElementById('closeScoreboardBtn');
    const closeScoreboardBtnX = document.querySelector('#scoreboardModal .close');
    
    viewScoreboardBtn.addEventListener('click', function() {
      scoreboardModal.style.display = 'block';
    });
    
    closeScoreboardBtnX.addEventListener('click', function() {
      scoreboardModal.style.display = 'none';
    });
    
    closeScoreboardBtn.addEventListener('click', function() {
      scoreboardModal.style.display = 'none';
    });
    
    // Close modals when clicking outside them
    window.addEventListener('click', function(event) {
      if (event.target === settingsModal) {
        settingsModal.style.display = 'none';
      }
      if (event.target === shotExplorationModal) {
        shotExplorationModal.style.display = 'none';
      }
      if (event.target === scoreboardModal) {
        scoreboardModal.style.display = 'none';
      }
      if (event.target === helpModal) {
        helpModal.style.display = 'none';
      }
    });
    
    // Help Modal Functions
    helpBtn.addEventListener('click', function() {
      helpModal.style.display = 'block';
    });
    
    closeHelpBtnX.addEventListener('click', function() {
      helpModal.style.display = 'none';
    });
    
    closeHelpBtn.addEventListener('click', function() {
      helpModal.style.display = 'none';
    });
    
    // Animation speed presets
    document.getElementById('presetVeryFast').addEventListener('click', function() {
      document.getElementById('animationSpeed').value = '48';
    });
    
    document.getElementById('presetSlowMotion').addEventListener('click', function() {
      document.getElementById('animationSpeed').value = '1';
    });
    
    // Close modals with Escape key and add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
      // Close modals with Escape key
      if (event.key === 'Escape') {
        settingsModal.style.display = 'none';
        shotExplorationModal.style.display = 'none';
        scoreboardModal.style.display = 'none';
        helpModal.style.display = 'none';
        
        // Also hide the scoring UI if it's visible
        const endScoringDisplay = document.getElementById('endScoringDisplay');
        if (endScoringDisplay.style.display === 'block') {
          endScoringDisplay.style.display = 'none';
        }
      }
      
      // Don't trigger shortcuts when inside input fields or modals are open
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || 
          settingsModal.style.display === 'block' || 
          shotExplorationModal.style.display === 'block' || 
          scoreboardModal.style.display === 'block' ||
          helpModal.style.display === 'block') {
        return;
      }
      
      // Keyboard shortcuts
      switch(event.key) {
        case 'Enter': // Throw rock
          document.getElementById('throwBtn').click();
          break;
        case 'r': // Reset
          document.getElementById('resetBtn').click();
          break;
        case 'n': // Next throw
          document.getElementById('nextThrowBtn').click();
          break;
        case 's': // Score end
          document.getElementById('scoreEndBtn').click();
          break;
        case 'v': // View scoreboard
          document.getElementById('viewScoreboardBtn').click();
          break;
        case '?': // Help
        case 'h': // Alternative help key
          document.getElementById('helpBtn').click();
          break;
      }
    });
  });
</script>
</body>
</html>
