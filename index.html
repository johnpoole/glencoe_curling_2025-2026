<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Curling Draw Simulator — D3</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div class="wrap">
  <!-- Sheet panel first (full width) -->
  <div class="panel">
    <svg id="rink"></svg>
  </div>
  
  <!-- Controls panel below -->
  <div class="panel controls-panel">
    <!-- First column - Shot parameters -->
    <fieldset>
      <legend>Shot</legend>
      <div class="row">
        <span class="input-label">Throw Weight (m/s)</span>
        <div class="slider-container">
          <input id="V0" type="range" step="0.01" min="0.1" max="6" value="2.0">
          <span class="slider-value" id="V0-value">2.0</span>
        </div>
      </div>
      <div class="row">
        <label>Spin |ω0| (rad/s)
          <input id="omega0" type="number" step="0.01" min="0" max="5" value="1.45">
        </label>
        <label>Turn
          <select id="turn"><option value="out">out (CW)</option><option value="in">in (CCW)</option></select>
        </label>
      </div>
      <label>Initial Sweep factor (×)
        <input id="sweep" type="number" step="0.01" min="0.5" max="1.5" value="1.0">
      </label>
      <div id="sweepControlsContainer" style="display: none; margin-top: 10px;">
        <div class="row" style="align-items: center;">
          <span>Active Sweeping</span>
          <div class="slider-container">
            <input id="activeSweep" type="range" step="0.01" min="0.5" max="1.0" value="0.75">
            <span class="slider-value" id="activeSweep-value">0.75</span>
          </div>
        </div>
        <div class="small" style="margin-top: 5px;">Press and hold the spacebar to sweep during shot</div>
      </div>
      <div style="text-align: right; margin-top: 10px;">
        <button id="settingsBtn" class="secondary" title="Advanced Settings">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
          Settings
        </button>
      </div>
      <div class="small">Click on the sheet to place the skip’s broom. Rock won’t move until you press <b>Throw</b>.</div>
    </fieldset>

    <!-- Third column - Buttons and metrics -->
    <div>
      <div class="buttons">
        <button id="throwBtn">Throw</button>
        <button id="resetBtn" class="secondary">Reset</button>
        <button id="csvBtn" class="secondary">Export CSV</button>
        <button id="stopBtn" class="warn">Stop</button>
      </div>
      
      <hr style="border:0;border-top:1px solid #2a3a52; margin:10px 0;">
      
      <!-- Stone control buttons -->
      <fieldset>
        <legend>Stones</legend>
        <div class="buttons">
          <button id="removeStoneBtn" class="secondary">Remove Selected</button>
          <button id="clearStonesBtn" class="warn">Clear All</button>
        </div>
        <div class="small" style="margin-top:8px">Stones are added automatically when you click Throw. Click a stone to select it for throwing or removing.</div>
      </fieldset>
      
      <fieldset style="margin-top: 20px; border: 2px solid #4aa3ff;">
        <legend style="font-weight: bold; color: #4aa3ff;">Shot Exploration</legend>
        <div class="buttons">
          <button id="showPathsBtn" class="secondary">Show Multiple Paths</button>
          <button id="hidePathsBtn" class="secondary">Hide Paths</button>
        </div>
        <div class="controls">
          <div class="control-group">
            <label for="broomSpacing">Broom Spacing (m):</label>
            <input type="number" id="broomSpacing" value="0.1524" step="0.0254" min="0.0254" max="0.5">
            <div class="small">(0.0254m = 1 inch)</div>
          </div>
          <div class="control-group">
            <label for="velocityStart">Velocity Start (m/s):</label>
            <input type="number" id="velocityStart" value="1.8" step="0.1" min="1.0" max="3.0">
          </div>
          <div class="control-group">
            <label for="velocityEnd">Velocity End (m/s):</label>
            <input type="number" id="velocityEnd" value="2.8" step="0.1" min="1.0" max="3.0">
          </div>
          <div class="control-group">
            <label for="velocityStep">Velocity Step (m/s):</label>
            <input type="number" id="velocityStep" value="0.1" step="0.05" min="0.05" max="0.5">
          </div>
          <div class="control-group" style="margin-top: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="showCollisions" checked>
              <label for="showCollisions" style="display: inline; margin: 0;">Show Collision Paths</label>
            </div>
          </div>
          <div class="control-group">
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="filterPaths" checked>
              <label for="filterPaths" style="display: inline; margin: 0;">Filter Invalid Paths</label>
            </div>
            <div class="small">Only show paths that stop on the sheet or cause collisions</div>
          </div>
        </div>
        <div class="small" style="margin-top:8px">Shows trajectories for different broom positions and velocities</div>
      </fieldset>
      
      <hr style="border:0;border-top:1px solid #2a3a52; margin:10px 0;">
      <div class="metrics-container">
        <div class="metric"><span>Final x (m)</span><span class="v" id="mx"></span></div>
        <div class="metric"><span>Final curl y (m)</span><span class="v" id="my"></span></div>
        <div class="metric"><span>Total time (s)</span><span class="v" id="mt"></span></div>
        <div class="metric"><span>Hog→Hog time (s)</span><span class="v" id="mhh"></span></div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Advanced Settings</h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <fieldset>
        <legend>Ice & Stone</legend>
        <div class="row">
          <label>ice speed
            <input id="mu0" type="number" step="0.0005" min="0.001" max="0.03" value="0.0075">
          </label>
          <label>stone sharpness
            <input id="alpha" type="number" step="0.0005" min="0.0" max="0.1" value="0.027">
          </label>
        </div>
      </fieldset>
      
      <fieldset>
        <legend>Advanced</legend>
        <div class="row">
          <label>segments
            <input id="segments" type="number" step="1" min="60" max="720" value="180">
          </label>
          <label>dt (s)
            <input id="dt" type="number" step="0.001" min="0.001" max="0.05" value="0.01">
          </label>
        </div>
        <div class="row">
          <label>t_max (s)
            <input id="tmax" type="number" step="1" min="5" max="120" value="60">
          </label>
          <label>r_band (m)
            <input id="rband" type="number" step="0.001" min="0.04" max="0.09" value="0.065">
          </label>
        </div>
        <label>R (rock radius, m)
          <input id="R" type="number" step="0.001" min="0.12" max="0.17" value="0.145">
        </label>
      </fieldset>
    </div>
    <div class="modal-footer">
      <button id="closeSettingsBtn" class="secondary">Close</button>
    </div>
  </div>
</div>

<script type="module" src="js/app.js"></script>
<script>
  // Modal functionality
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('settingsModal');
    const settingsBtn = document.getElementById('settingsBtn');
    const closeBtn = document.querySelector('.close');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    
    // Open the modal when the settings button is clicked
    settingsBtn.addEventListener('click', function() {
      modal.style.display = 'block';
    });
    
    // Close the modal when the X is clicked
    closeBtn.addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    // Close the modal when the Close button is clicked
    closeSettingsBtn.addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    // Close the modal when clicking outside it
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
  });
</script>
</body>
</html>
